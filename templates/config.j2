{# If value is a list, expand it by printing several (key, value) pairs.  #}
{# Otherwise, just print the (key, value) pair unchanged. #}
{% macro expand_list(key, value) -%}
{% if value is string or value is number %}
  {{ key }}: "{{ value }}"
{% else %}
{% for subvalue in value %}
  {{ key }}: "{{ subvalue }}"
{% endfor %}
{% endif %}
{%- endmacro %}
{% macro emit_pattern(pattern) %}
pattern:
  # Local configuration
  name: {{pattern.name}}
{%     if pattern.include_pattern|default(false) %}
  include-pattern: {{pattern.include_pattern}}
{%     endif %}
{%     if pattern.zonefile|default(false) %}
  zonefile: {{pattern.zonefile}}
{%     endif %}
{%     for key, options in pattern.items() %}
{%       for value in options %}
{%         if key == 'allow-notify' %}
  allow-notify: {{value.ip}} {{value.key|default('NOKEY')}}
{%         elif key == 'request-xfr' %}
  request-xfr: {{value.type|default('')}} {{value.ip}} {{value.key|default('NOKEY')}}
{%         elif key == 'notify' %}
  notify: {{value.ip}} {{value.key|default('NOKEY')}}
{%         elif key == 'provide-xfr' %}
  provide-xfr: {{value.ip}} {{value.key|default('NOKEY')}}
{%         elif key == 'name' %}
{# ignore name #}
{%         elif key == "include_pattern" %}
{# ignore include-pattern #}
{%         else %}
{{ expand_list(key, value) }}
{%         endif %}
{%       endfor %}
{%-    endfor %}
{%- endmacro %}
# NSD configuration, automatically generated by Ansible.
# Do not edit by hand!

server:
{% if nsd_server_config is defined %}
  # Common configuration
{% for key, value in nsd_server_config.items() -%}
{{ expand_list(key, value) }}
{%- endfor %}
{% endif %}

{% if nsd_local_server_config is defined %}
  # Local configuration
{% for key, value in nsd_local_server_config.items() -%}
{{ expand_list(key, value) }}
{%- endfor %}
{% endif %}

{# only one remote-control section is allowed #}
remote-control:
{% if nsd_remote_control_config is defined %}
  # Common configuration
{%   for key, value in nsd_remote_control_config.items() -%}
{{ expand_list(key, value) }}
{%-  endfor %}
{% endif %}
{% if nsd_local_remote_control_config is defined %}
  # Local configuration
{%   for key, value in nsd_local_remote_control_config.items() -%}
{{ expand_list(key, value) }}
{%-  endfor %}
{% endif %}

{# there can be multiple pattern sections #}
{% if nsd_pattern_config is defined %}
{%   for pattern in nsd_pattern_config -%}
{{ emit_pattern(pattern) }}
{%-  endfor %}
{% endif %}

{% if nsd_local_pattern_config is defined %}
{%   for pattern in nsd_local_pattern_config -%}
{{ emit_pattern(pattern) }}
{%-  endfor %}
{% endif %}

# Include zone definitions
include: "{{ nsd_zones_config_file }}"

